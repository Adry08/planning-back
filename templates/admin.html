<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Planning ‚Äì Admin</title>

<style>
:root {
  --bg: #0d1117;
  --panel: #161b22;
  --border: #30363d;
  --text: #c9d1d9;
  --muted: #8b949e;
  --green: #238636;
  --red: #da3633;
  --blue: #1f6feb;
}

* { box-sizing: border-box; font-family: system-ui, -apple-system, sans-serif; }

body {
  margin: 0;
  background: var(--bg);
  color: var(--text);
  padding: 20px;
}

.container {
  max-width: 900px;
  margin: auto;
}

h1 {
  font-size: 1.5rem;
  margin-bottom: 20px;
}

.card {
  background: var(--panel);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 16px;
  margin-bottom: 16px;
}

.card h2 {
  font-size: 1.1rem;
  margin: 0 0 12px 0;
}

button {
  background: var(--blue);
  border: none;
  color: white;
  padding: 10px 14px;
  border-radius: 6px;
  cursor: pointer;
}

button:disabled {
  opacity: .5;
  cursor: not-allowed;
}

.alert {
  margin-top: 10px;
  padding: 10px;
  border-radius: 6px;
  font-size: .9rem;
}

.alert.success { background: rgba(35,134,54,.2); color: #3fb950; }
.alert.error { background: rgba(218,54,51,.2); color: #f85149; }
.alert.info { background: rgba(31,111,235,.2); color: #58a6ff; }

.upload-zone {
  border: 2px dashed var(--border);
  border-radius: 8px;
  padding: 30px;
  text-align: center;
  cursor: pointer;
}

.upload-zone.drag {
  border-color: var(--blue);
}

.progress {
  height: 8px;
  background: var(--border);
  border-radius: 4px;
  overflow: hidden;
  margin-top: 10px;
}

.progress div {
  height: 100%;
  width: 0%;
  background: var(--green);
  transition: width .3s;
}

pre {
  background: #010409;
  padding: 12px;
  border-radius: 6px;
  overflow: auto;
  max-height: 300px;
  font-size: .8rem;
}
</style>
</head>

<body>
<div class="container">
  <h1>‚öôÔ∏è Planning ‚Äì Administration</h1>

  <!-- TOKEN -->
  <div class="card">
    <h2>üîê V√©rification token GitHub</h2>
    <button onclick="checkToken()">V√©rifier le token</button>
    <div id="tokenStatus"></div>
  </div>

  <!-- CONNEXION -->
  <div class="card">
    <h2>üîó Connexion au d√©p√¥t</h2>
    <button onclick="checkRepo()">V√©rifier la connexion</button>
    <div id="repoStatus"></div>
  </div>

  <!-- UPLOAD -->
  <div class="card">
    <h2>üì§ Upload du fichier Excel</h2>

    <div class="upload-zone" id="dropZone">
      Glisse le fichier Excel ici ou clique pour s√©lectionner
      <input type="file" id="fileInput" hidden accept=".xlsx,.xls"/>
    </div>

    <div class="progress"><div id="progressBar"></div></div>
    <div id="uploadStatus"></div>
  </div>

  <!-- JSON -->
  <div class="card">
    <h2>üìÑ JSON qui va √™tre push</h2>
    <pre id="jsonPreview">Aucun fichier trait√©</pre>
  </div>
</div>

<script>
const dropZone = document.getElementById('dropZone');
const fileInput = document.getElementById('fileInput');
const progressBar = document.getElementById('progressBar');

dropZone.onclick = () => fileInput.click();

dropZone.ondragover = e => {
  e.preventDefault();
  dropZone.classList.add('drag');
};

dropZone.ondragleave = () => dropZone.classList.remove('drag');

dropZone.ondrop = e => {
  e.preventDefault();
  dropZone.classList.remove('drag');
  handleFile(e.dataTransfer.files[0]);
};

fileInput.onchange = e => handleFile(e.target.files[0]);

function alertBox(target, msg, type) {
  target.innerHTML = `<div class="alert ${type}">${msg}</div>`;
}

async function checkToken() {
  const target = document.getElementById('tokenStatus');
  alertBox(target, "V√©rification du token‚Ä¶", "info");

  const res = await fetch('/health/github');
  const data = await res.json();

  if (data.status === 'ok') {
    alertBox(target, "Token GitHub valide ‚úîÔ∏è", "success");
  } else {
    alertBox(target, data.error || "Token invalide ‚ùå", "error");
  }
}

async function checkRepo() {
  const target = document.getElementById('repoStatus');
  alertBox(target, "Connexion au d√©p√¥t en cours‚Ä¶", "info");

  const res = await fetch('/health/github');
  const data = await res.json();

  if (data.status === 'ok') {
    alertBox(target, "Connexion au d√©p√¥t r√©ussie ‚úîÔ∏è", "success");
  } else {
    alertBox(target, data.error || "Erreur d√©p√¥t ‚ùå", "error");
  }
}

async function handleFile(file) {
  if (!file) return;

  progressBar.style.width = '0%';
  alertBox(uploadStatus, "Upload en cours‚Ä¶", "info");

  const form = new FormData();
  form.append('file', file);

  const xhr = new XMLHttpRequest();
  xhr.open("POST", "/upload");

  xhr.upload.onprogress = e => {
    if (e.lengthComputable) {
      progressBar.style.width = (e.loaded / e.total * 100) + '%';
    }
  };

  xhr.onload = () => {
    const res = JSON.parse(xhr.responseText);
    if (xhr.status === 200) {
      alertBox(uploadStatus, "Fichier trait√© et push GitHub ‚úîÔ∏è", "success");
      document.getElementById('jsonPreview').textContent =
        JSON.stringify(res.json, null, 2);
    } else {
      alertBox(uploadStatus, res.error || "Erreur upload ‚ùå", "error");
    }
  };

  xhr.send(form);
}
</script>
</body>
</html>