<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Planning ‚Äì Admin</title>
<style>
:root {
  --bg:#0d1117; --panel:#161b22; --border:#30363d;
  --text:#c9d1d9; --muted:#8b949e;
  --green:#238636; --red:#da3633; --blue:#1f6feb;
}
*{box-sizing:border-box;font-family:system-ui}
body{margin:0;background:var(--bg);color:var(--text);padding:20px}
.container{max-width:900px;margin:auto}
h1{margin-bottom:20px}

.card{
  background:var(--panel);
  border:1px solid var(--border);
  border-radius:8px;
  padding:16px;
  margin-bottom:16px;
}

input{
  width:100%;
  padding:10px;
  background:#010409;
  border:1px solid var(--border);
  color:var(--text);
  border-radius:6px;
}

button{
  background:var(--blue);
  border:none;
  color:#fff;
  padding:10px 14px;
  border-radius:6px;
  cursor:pointer;
}

button.secondary{background:#21262d}
button:disabled{opacity:.5;cursor:not-allowed}

.alert{
  margin-top:10px;
  padding:10px;
  border-radius:6px;
  font-size:.9rem;
}
.success{background:rgba(35,134,54,.2);color:#3fb950}
.error{background:rgba(218,54,51,.2);color:#f85149}
.info{background:rgba(31,111,235,.2);color:#58a6ff}

.upload-zone{
  border:2px dashed var(--border);
  padding:30px;
  text-align:center;
  border-radius:8px;
  cursor:pointer;
}

.upload-zone.drag{border-color: var(--blue)}

.progress{height:8px;background:var(--border);margin-top:10px;border-radius:4px}
.progress div{height:100%;width:0;background:var(--green);transition: width .3s}

pre{
  background:#010409;
  padding:12px;
  border-radius:6px;
  max-height:300px;
  overflow:auto;
}
</style>
</head>

<body>
<div class="container">
<h1>‚öôÔ∏è Planning ‚Äì Admin</h1>

<!-- ADMIN TOKEN -->
<div class="card">
<h2>üîê Admin token</h2>
<input type="password" id="adminToken" placeholder="Admin token">
<button onclick="checkAuth()">V√©rifier</button>
<div id="authStatus"></div>
</div>

<!-- CONNEXION GITHUB -->
<div class="card">
<h2>üîó Connexion GitHub</h2>
<button id="btnRepo" onclick="checkRepo()" disabled>V√©rifier la connexion</button>
<div id="repoStatus"></div>
</div>

<!-- UPLOAD EXCEL -->
<div class="card">
<h2>üì§ Upload Excel</h2>
<div class="upload-zone" id="dropZone">
  Glisse ton fichier Excel ici ou clique pour s√©lectionner
</div>
<input type="file" id="fileInput" hidden accept=".xlsx,.xls"/>
<div class="progress"><div id="progressBar"></div></div>
<div id="uploadStatus"></div>
</div>

<!-- JSON PREVIEW + PUSH -->
<div class="card">
<h2>üìÑ JSON g√©n√©r√©</h2>
<pre id="jsonPreview">Aucun fichier</pre>
<button id="btnPush" class="secondary" onclick="pushGitHub()" disabled>üöÄ Push vers GitHub</button>
<div id="pushStatus"></div>
</div>
</div>

<script>
let ADMIN_OK=false;
let GENERATED_JSON=null;

const fileInput=document.getElementById('fileInput');
const dropZone=document.getElementById('dropZone');
const progressBar=document.getElementById('progressBar');

dropZone.onclick = ()=>fileInput.click();
dropZone.ondragover = e => { e.preventDefault(); dropZone.classList.add('drag'); }
dropZone.ondragleave = ()=>dropZone.classList.remove('drag');
dropZone.ondrop = e => { e.preventDefault(); dropZone.classList.remove('drag'); handleFile(e.dataTransfer.files[0]); }
fileInput.onchange = e => handleFile(fileInput.files[0]);

function alertBox(targetId,msg,type){
  document.getElementById(targetId).innerHTML=`<div class="alert ${type}">${msg}</div>`;
}

async function checkAuth(){
  const token=document.getElementById('adminToken').value;
  alertBox("authStatus","V√©rification‚Ä¶","info");
  try{
    const res=await fetch("/health/github",{headers:{"x-admin-token":token}});
    const data=await res.json();
    if(data.status==="ok"){
      ADMIN_OK=true;
      alertBox("authStatus","Token valide ‚úîÔ∏è","success");
      document.getElementById("btnRepo").disabled=false;
    }else{
      alertBox("authStatus",data.error || "Token invalide ‚ùå","error");
      document.getElementById("btnRepo").disabled=true;
    }
  }catch(e){
    alertBox("authStatus","Erreur connexion ‚ùå","error");
  }
}

async function checkRepo(){
  if(!ADMIN_OK) return;
  const token=document.getElementById('adminToken').value;
  alertBox("repoStatus","V√©rification repo‚Ä¶","info");
  try{
    const res=await fetch("/health/github",{headers:{"x-admin-token":token}});
    const data=await res.json();
    if(data.status==="ok") alertBox("repoStatus","Repo OK ‚úîÔ∏è","success");
    else alertBox("repoStatus",data.error,"error");
  }catch(e){
    alertBox("repoStatus","Erreur ‚ùå","error");
  }
}

async function handleFile(file){
  if(!file || !ADMIN_OK) return;
  progressBar.style.width="0%";
  alertBox("uploadStatus","Upload en cours‚Ä¶","info");

  const token=document.getElementById('adminToken').value;
  const formData=new FormData();
  formData.append("file",file);

  const xhr=new XMLHttpRequest();
  xhr.open("POST","/upload");
  xhr.setRequestHeader("x-admin-token",token);

  xhr.upload.onprogress = e => {
    if(e.lengthComputable) progressBar.style.width=(e.loaded/e.total*100)+"%";
  };

  xhr.onload = () => {
    const res=JSON.parse(xhr.responseText);
    if(xhr.status===200){
      GENERATED_JSON=res.json;
      document.getElementById("jsonPreview").textContent=JSON.stringify(GENERATED_JSON,null,2);
      document.getElementById("btnPush").disabled=false;
      alertBox("uploadStatus","JSON pr√™t ‚úîÔ∏è","success");
    }else{
      alertBox("uploadStatus",res.error || "Erreur ‚ùå","error");
    }
  };

  xhr.send(formData);
}

async function pushGitHub(){
  if(!GENERATED_JSON || !ADMIN_OK) return;
  alertBox("pushStatus","Push en cours‚Ä¶","info");
  const token=document.getElementById('adminToken').value;

  const res=await fetch("/push",{
    method:"POST",
    headers:{
      "Content-Type":"application/json",
      "x-admin-token":token
    },
    body:JSON.stringify(GENERATED_JSON)
  });
  const data=await res.json();
  if(data.status==="ok") alertBox("pushStatus",data.message,"success");
  else alertBox("pushStatus",data.error || "Erreur push ‚ùå","error");
}
</script>
</body>
</html>